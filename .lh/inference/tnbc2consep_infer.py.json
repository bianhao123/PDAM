{
    "sourceFile": "inference/tnbc2consep_infer.py",
    "activeCommit": 0,
    "commits": [
        {
            "activePatchIndex": 4,
            "patches": [
                {
                    "date": 1674925366398,
                    "content": "Index: \n===================================================================\n--- \n+++ \n"
                },
                {
                    "date": 1674925773283,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -28,9 +28,9 @@\n         model=model\n     )\n \n     # with testing images\n-    test_root_name = '/data111/bianhao/code/zhangye/PDAM/ZY_CVPR/tnbc/coco/test/source_images'\n+    test_root_name = '/data111/bianhao/code/zhangye/PDAM/datasets/consep/test/source_images'\n \n     mkdir(out_pred_root)\n \n     test_imgs = os.listdir(test_root_name)\n"
                },
                {
                    "date": 1674925822559,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -65,7 +65,7 @@\n \n \n if __name__ == \"__main__\":\n     wts_root = '/data111/bianhao/code/zhangye/PDAM/work_dir/consep2tnbc-models/pdam/model_epoch_010.pth'\n-    out_pred_root = 'consep2tnbc'\n+    out_pred_root = 'tnbc2consep'\n \n     infer_fluo2tnbc(wts_root, out_pred_root)\n"
                },
                {
                    "date": 1674926075505,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -64,8 +64,9 @@\n                     image.shape[:2], dtype=np.uint16))\n \n \n if __name__ == \"__main__\":\n-    wts_root = '/data111/bianhao/code/zhangye/PDAM/work_dir/consep2tnbc-models/pdam/model_epoch_010.pth'\n-    out_pred_root = 'tnbc2consep'\n+    setting = 'tnbc2consep'\n+    wts_root = f'/data111/bianhao/code/zhangye/PDAM/work_dir/{setting}-models/pdam/model_epoch_010.pth'\n+    out_pred_root = setting\n \n     infer_fluo2tnbc(wts_root, out_pred_root)\n"
                },
                {
                    "date": 1674926120051,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -10,11 +10,11 @@\n import numpy as np\n from maskrcnn_benchmark.modeling.detector import build_detection_model\n \n \n-def infer_fluo2tnbc(wts_root, out_pred_root):\n+def infer_fluo2tnbc(wts_root, out_pred_root, setting):\n \n-    config_file = \"../configs/uda_nuclei_seg/e2e_mask_rcnn_R_101_FPN_1x_gn_tnbc2consep.yaml\"\n+    config_file = f\"../configs/uda_nuclei_seg/e2e_mask_rcnn_R_101_FPN_1x_gn_{setting}.yaml\"\n \n     cfg.merge_from_file(config_file)\n \n     cfg.merge_from_list([\"MODEL.DEVICE\", \"cuda\"])\n@@ -68,5 +68,5 @@\n     setting = 'tnbc2consep'\n     wts_root = f'/data111/bianhao/code/zhangye/PDAM/work_dir/{setting}-models/pdam/model_epoch_010.pth'\n     out_pred_root = setting\n \n-    infer_fluo2tnbc(wts_root, out_pred_root)\n+    infer_fluo2tnbc(wts_root, out_pred_root, setting)\n"
                }
            ],
            "date": 1674925366398,
            "name": "Commit-0",
            "content": "\n\nimport cv2\nfrom maskrcnn_benchmark.utils.miscellaneous import mkdir\nimport tifffile as tiff\nfrom inference.cell_predictor import CellDemo\nfrom inference.metrics import mask2out, removeoverlap\nfrom maskrcnn_benchmark.config import cfg\nimport os\nimport numpy as np\nfrom maskrcnn_benchmark.modeling.detector import build_detection_model\n\n\ndef infer_fluo2tnbc(wts_root, out_pred_root):\n\n    config_file = \"../configs/uda_nuclei_seg/e2e_mask_rcnn_R_101_FPN_1x_gn_tnbc2consep.yaml\"\n\n    cfg.merge_from_file(config_file)\n\n    cfg.merge_from_list([\"MODEL.DEVICE\", \"cuda\"])\n    model = build_detection_model(cfg)\n\n    cell_demo = CellDemo(\n        cfg,\n        min_image_size=256,\n        confidence_threshold=0.5,\n        weight=wts_root,\n        model=model\n    )\n\n    # with testing images\n    test_root_name = '/data111/bianhao/code/zhangye/PDAM/ZY_CVPR/tnbc/coco/test/source_images'\n\n    mkdir(out_pred_root)\n\n    test_imgs = os.listdir(test_root_name)\n    for img_name in test_imgs:\n\n        if img_name.endswith(\".png\"):\n            image = cv2.imread(os.path.join(test_root_name, img_name))\n\n            # compute predictions\n            predictions, mask_list = cell_demo.run_on_opencv_image(image)\n\n            if mask_list.shape[-1]:\n                masks_no_overlap, bi_map, num_mask = removeoverlap(mask_list)\n                pred_ins = mask2out(masks_no_overlap, num_mask)\n\n                cv2.imwrite(os.path.join(out_pred_root, img_name), predictions)\n                cv2.imwrite(os.path.join(out_pred_root, 'bi_mask_' +\n                            img_name), (bi_map * 255).astype(np.uint8))\n\n                pred_ins_name = os.path.join(\n                    out_pred_root, img_name.split('.')[0] + '.tif')\n                tiff.imsave(pred_ins_name, pred_ins)\n\n            else:\n                cv2.imwrite(os.path.join(out_pred_root, img_name), predictions)\n                cv2.imwrite(os.path.join(out_pred_root, 'bi_mask_' +\n                            img_name), np.zeros(image.shape[:2], dtype=np.uint8))\n                pred_ins_name = os.path.join(\n                    out_pred_root, img_name.split('.')[0] + '.tif')\n                tiff.imsave(pred_ins_name, np.zeros(\n                    image.shape[:2], dtype=np.uint16))\n\n\nif __name__ == \"__main__\":\n    wts_root = '/data111/bianhao/code/zhangye/PDAM/work_dir/consep2tnbc-models/pdam/model_epoch_010.pth'\n    out_pred_root = 'consep2tnbc'\n\n    infer_fluo2tnbc(wts_root, out_pred_root)\n"
        }
    ]
}